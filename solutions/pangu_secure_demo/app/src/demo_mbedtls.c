/*
 * Copyright (C) 2019-2020 Alibaba Group Holding Limited
 */

#include "app_main.h"
#include "mbedtls/sha256.h"
#include "mbedtls/sha1.h"
#include "mbedtls/rsa.h"
#include "mbedtls/ctr_drbg.h"
#include "mbedtls/entropy.h"


extern int mbedtls_entropy_func( void *data, unsigned char *output, size_t len );

static const unsigned char entropy_source_pr[96] =
    {0xc1, 0x80, 0x81, 0xa6, 0x5d, 0x44, 0x02, 0x16,
     0x19, 0xb3, 0xf1, 0x80, 0xb1, 0xc9, 0x20, 0x02,
     0x6a, 0x54, 0x6f, 0x0c, 0x70, 0x81, 0x49, 0x8b,
     0x6e, 0xa6, 0x62, 0x52, 0x6d, 0x51, 0xb1, 0xcb,
     0x58, 0x3b, 0xfa, 0xd5, 0x37, 0x5f, 0xfb, 0xc9,
     0xff, 0x46, 0xd2, 0x19, 0xc7, 0x22, 0x3e, 0x95,
     0x45, 0x9d, 0x82, 0xe1, 0xe7, 0x22, 0x9f, 0x63,
     0x31, 0x69, 0xd2, 0x6b, 0x57, 0x47, 0x4f, 0xa3,
     0x37, 0xc9, 0x98, 0x1c, 0x0b, 0xfb, 0x91, 0x31,
     0x4d, 0x55, 0xb9, 0xe9, 0x1c, 0x5a, 0x5e, 0xe4,
     0x93, 0x92, 0xcf, 0xc5, 0x23, 0x12, 0xd5, 0x56,
     0x2c, 0x4a, 0x6e, 0xff, 0xdc, 0x10, 0xd0, 0x68};
static const unsigned char nonce_pers_pr[16] =
    {0xd2, 0x54, 0xfc, 0xff, 0x02, 0x1e, 0x69, 0xd2,
     0x29, 0xc9, 0xcf, 0xad, 0x85, 0xfa, 0x48, 0x6c};

void test_mbedtls()
{

    printf("===%s, %d, %x\n", __FUNCTION__, __LINE__, 0);
    int ret;
    mbedtls_ctr_drbg_context ctr_drbg;
    unsigned char buf[16];

    mbedtls_ctr_drbg_init(&ctr_drbg);

    ret = mbedtls_ctr_drbg_seed(&ctr_drbg,
                                mbedtls_entropy_func,
                                (void *)entropy_source_pr,
                                nonce_pers_pr, 16);
    CHECK_RESULT(ret == 0);

    ret = mbedtls_ctr_drbg_random(&ctr_drbg, buf, MBEDTLS_CTR_DRBG_BLOCKSIZE);
    CHECK_RESULT(ret == 0);
    printf("===%s, %d, %x\n", __FUNCTION__, __LINE__, ret);

    ret = 0;
}

void mbedtls_demo_main()
{
#ifdef CONFIG_SECURITY_DEMO_MBEDTLS
    mbedtls_aes_self_test(1);
    mbedtls_sha1_self_test(1);
    mbedtls_sha256_self_test(1);
    mbedtls_rsa_self_test(1);
#if 0
    test_mbedtls();
    mbedtls_ctr_drbg_self_test(1);
#endif
#endif
}